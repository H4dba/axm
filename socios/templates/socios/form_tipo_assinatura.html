{% extends 'base.html' %}

{% block title %}
    {% if tipo.id %}Editar Tipo de Assinatura{% else %}Novo Tipo de Assinatura{% endif %} - ClubPro
{% endblock %}

{% block content %}
<div class="tipo-assinatura-form fade-in-up">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="page-title">
                            <i class="fas {% if tipo.id %}fa-edit{% else %}fa-plus{% endif %} text-gold me-3"></i>
                            {% if tipo.id %}Editar Tipo de Assinatura{% else %}Novo Tipo de Assinatura{% endif %}
                        </h1>
                        <p class="page-subtitle">
                            {% if tipo.id %}
                                Atualize as informações do tipo {{ tipo.nome }}
                            {% else %}
                                Configure um novo plano de assinatura para o clube
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{% url 'socios:tipos_assinatura' %}" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>
                            Voltar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    <form method="post" id="tipoForm" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Seção Principal -->
            <div class="col-lg-8">
                <!-- Informações Básicas -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informações Básicas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.nome.id_for_label }}" class="form-label required">
                                    Nome do Tipo
                                </label>
                                {{ form.nome }}
                                {% if form.nome.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nome.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Nome identificador do plano de assinatura</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.cor.id_for_label }}" class="form-label">
                                    Cor do Tipo
                                </label>
                                <div class="input-group">
                                    {{ form.cor }}
                                    <div class="color-preview" id="colorPreview"></div>
                                </div>
                                {% if form.cor.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.cor.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Cor para identificação visual do tipo</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.descricao.id_for_label }}" class="form-label">
                                Descrição
                            </label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.descricao.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">Descrição detalhada dos benefícios e características do plano</div>
                        </div>
                    </div>
                </div>

                <!-- Configurações Financeiras -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-dollar-sign me-2"></i>
                            Configurações Financeiras
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.valor_mensal.id_for_label }}" class="form-label required">
                                    Valor Mensal
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_mensal }}
                                </div>
                                {% if form.valor_mensal.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.valor_mensal.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Valor cobrado mensalmente</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.valor_anual.id_for_label }}" class="form-label">
                                    Valor Anual (Opcional)
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_anual }}
                                </div>
                                {% if form.valor_anual.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.valor_anual.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Valor para pagamento anual com desconto</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.duracao_dias.id_for_label }}" class="form-label required">
                                    Duração em Dias
                                </label>
                                {{ form.duracao_dias }}
                                {% if form.duracao_dias.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.duracao_dias.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Duração padrão da assinatura em dias</div>
                            </div>
                        </div>

                        <!-- Benefícios -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.desconto_eventos.id_for_label }}" class="form-label">
                                    Desconto em Eventos (%)
                                </label>
                                {{ form.desconto_eventos }}
                                {% if form.desconto_eventos.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.desconto_eventos.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Percentual de desconto em eventos especiais</div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.aulas_incluidas.id_for_label }}" class="form-label">
                                    Aulas Incluídas/Mês
                                </label>
                                {{ form.aulas_incluidas }}
                                {% if form.aulas_incluidas.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.aulas_incluidas.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Número de aulas incluídas mensalmente</div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch mt-4">
                                    {{ form.acesso_torneios }}
                                    <label class="form-check-label" for="{{ form.acesso_torneios.id_for_label }}">
                                        <strong>Acesso a Torneios</strong>
                                    </label>
                                    {% if form.acesso_torneios.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.acesso_torneios.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">Permite participação em torneios do clube</div>
                                </div>
                            </div>
                        </div>

                        <!-- Cálculos Automáticos -->
                        <div class="calculation-preview mt-4 p-3 bg-light rounded">
                            <h6 class="mb-3">
                                <i class="fas fa-calculator me-2"></i>
                                Projeções Financeiras
                            </h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="calc-item">
                                        <div class="calc-label">Valor Mensal</div>
                                        <div class="calc-value" id="valorMensal">R$ 0,00</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="calc-item">
                                        <div class="calc-label">Valor Trimestral</div>
                                        <div class="calc-value" id="valorTrimestral">R$ 0,00</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="calc-item">
                                        <div class="calc-label">Valor Semestral</div>
                                        <div class="calc-value" id="valorSemestral">R$ 0,00</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="calc-item">
                                        <div class="calc-label">Valor Anual</div>
                                        <div class="calc-value" id="valorAnual">R$ 0,00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if tipo.id %}
                <!-- Estatísticas do Tipo -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Estatísticas do Tipo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">{{ tipo.total_socios|default:0 }}</div>
                                    <div class="stat-label">Sócio{{ tipo.total_socios|default:0|pluralize }}</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">R$ {{ tipo.receita_mensal|default:0|floatformat:2 }}</div>
                                    <div class="stat-label">Receita Mensal</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">R$ {{ tipo.receita_anual|default:0|floatformat:2 }}</div>
                                    <div class="stat-label">Receita Anual</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">{{ tipo.participacao_percentual|default:0 }}%</div>
                                    <div class="stat-label">Participação</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if tipo.total_socios > 0 %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Este tipo tem sócios vinculados. Alterações nos valores afetarão futuras cobranças.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Preview do Tipo -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Preview do Tipo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="tipo-preview" id="tipoPreview">
                            <div class="preview-header">
                                <h6 class="preview-nome">Nome do Tipo</h6>
                                <span class="preview-badge">Periodicidade</span>
                            </div>
                            <div class="preview-preco">
                                <span class="preview-valor">R$ 0,00</span>
                                <span class="preview-periodo">/ período</span>
                            </div>
                            <div class="preview-descricao">
                                <p class="text-muted">Descrição aparecerá aqui...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status e Configurações -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Configurações
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            {{ form.ativo }}
                            <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                <strong>Tipo Ativo</strong>
                            </label>
                            {% if form.ativo.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.ativo.errors.0 }}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Tipos inativos não aparecem no cadastro de novos sócios
                            </div>
                        </div>
                        
                        {% if tipo.id %}
                        <div class="info-display">
                            <label class="form-label">Data de Criação</label>
                            <div class="info-value">{{ tipo.data_criacao|date:"d/m/Y H:i" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Ações -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-gold btn-lg">
                                <i class="fas {% if tipo.id %}fa-save{% else %}fa-plus{% endif %} me-2"></i>
                                {% if tipo.id %}Salvar Alterações{% else %}Criar Tipo{% endif %}
                            </button>
                            
                            <a href="{% url 'socios:tipos_assinatura' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                            
                            {% if tipo.id %}
                                <hr>
                                <a href="{% url 'socios:listar' %}?plano={{ tipo.id }}" class="btn btn-outline-info">
                                    <i class="fas fa-users me-2"></i>
                                    Ver Sócios ({{ tipo.total_socios|default:0 }})
                                </a>
                                
                                {% if tipo.total_socios == 0 %}
                                <button type="button" class="btn btn-outline-danger" onclick="confirmarExclusao()">
                                    <i class="fas fa-trash me-2"></i>
                                    Excluir Tipo
                                </button>
                                {% else %}
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Não é possível excluir tipos com sócios vinculados
                                </small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Confirmação de Exclusão -->
{% if tipo.id and tipo.total_socios == 0 %}
<div class="modal fade" id="modalExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o tipo <strong>{{ tipo.nome }}</strong>?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Esta ação não pode ser desfeita.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="{% url 'socios:excluir_tipo' tipo.id %}" class="btn btn-danger">
                    <i class="fas fa-trash me-1"></i>
                    Confirmar Exclusão
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    /* Form Styles */
    .tipo-assinatura-form {
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        background: var(--gradient-primary);
        color: var(--white);
        padding: 2rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }

    /* Form Controls */
    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }

    .color-preview {
        width: 40px;
        height: 38px;
        border: 1px solid var(--gray-300);
        border-radius: 0 var(--radius-md) var(--radius-md) 0;
        background: var(--gray-200);
    }

    /* Calculations */
    .calculation-preview {
        border-left: 4px solid var(--primary-color);
    }

    .calc-item {
        text-align: center;
        margin-bottom: 1rem;
    }

    .calc-label {
        font-size: 0.75rem;
        color: var(--gray-600);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .calc-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Preview */
    .tipo-preview {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        text-align: center;
        background: var(--light-gray);
    }

    .preview-header {
        margin-bottom: 1rem;
    }

    .preview-nome {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .preview-badge {
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--primary-color);
        color: var(--white);
    }

    .preview-preco {
        margin-bottom: 1rem;
    }

    .preview-valor {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        display: block;
    }

    .preview-periodo {
        font-size: 0.9rem;
        color: var(--gray-600);
    }

    .preview-descricao p {
        font-size: 0.9rem;
        margin: 0;
    }

    /* Stats */
    .stat-card {
        text-align: center;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: var(--radius-md);
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        display: block;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--gray-600);
        text-transform: uppercase;
        font-weight: 600;
    }

    /* Info Display */
    .info-display .form-label {
        margin-bottom: 0.25rem;
        font-weight: 600;
        color: var(--gray-700);
    }

    .info-value {
        padding: 0.5rem;
        background: var(--light-gray);
        border-radius: var(--radius-sm);
        color: var(--gray-800);
    }

    /* Card Headers */
    .card-header {
        background: var(--light-gray);
        border-bottom: 1px solid var(--gray-200);
    }

    .card-header h5 {
        color: var(--gray-800);
        font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-title {
            font-size: 1.5rem;
        }

        .calc-item, .stat-card {
            margin-bottom: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const valorMensalInput = document.getElementById('id_valor_mensal');
        const valorAnualInput = document.getElementById('id_valor_anual');
        const duracaoInput = document.getElementById('id_duracao_dias');
        const corInput = document.getElementById('id_cor');
        const nomeInput = document.getElementById('id_nome');
        const descricaoInput = document.getElementById('id_descricao');

        // Atualizar preview da cor
        function atualizarCorPreview() {
            const cor = corInput.value || '#3498db';
            document.getElementById('colorPreview').style.backgroundColor = cor;
            
            // Atualizar cor no preview do tipo
            const previewBadge = document.querySelector('.preview-badge');
            if (previewBadge) {
                previewBadge.style.backgroundColor = cor;
            }
        }

        // Atualizar cálculos financeiros
        function atualizarCalculos() {
            const valorMensal = parseFloat(valorMensalInput.value) || 0;
            const valorAnual = parseFloat(valorAnualInput.value) || (valorMensal * 12);
            const duracao = parseInt(duracaoInput.value) || 30;
            
            // Calcular valor proporcional baseado na duração
            const valorPorDia = valorMensal / 30;
            const valorPorPeriodo = valorPorDia * duracao;
            
            document.getElementById('valorMensal').textContent = `R$ ${valorMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('valorTrimestral').textContent = `R$ ${(valorMensal * 3).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('valorSemestral').textContent = `R$ ${(valorMensal * 6).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('valorAnual').textContent = `R$ ${valorAnual.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            // Atualizar o valor no preview
            atualizarPreview();
        }

        // Atualizar preview do tipo
        function atualizarPreview() {
            const nome = nomeInput.value || 'Nome do Tipo';
            const valorMensal = parseFloat(valorMensalInput.value) || 0;
            const duracao = parseInt(duracaoInput.value) || 30;
            const descricao = descricaoInput.value || 'Descrição aparecerá aqui...';
            
            document.querySelector('.preview-nome').textContent = nome;
            document.querySelector('.preview-valor').textContent = `R$ ${valorMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            // Determinar periodicidade baseada na duração
            let periodicidadeTexto = 'Mensal';
            if (duracao >= 365) {
                periodicidadeTexto = 'Anual';
            } else if (duracao >= 180) {
                periodicidadeTexto = 'Semestral';
            } else if (duracao >= 90) {
                periodicidadeTexto = 'Trimestral';
            } else if (duracao > 30) {
                periodicidadeTexto = `${duracao} dias`;
            }
            
            document.querySelector('.preview-badge').textContent = periodicidadeTexto;
            document.querySelector('.preview-periodo').textContent = `/ ${periodicidadeTexto.toLowerCase()}`;
            document.querySelector('.preview-descricao p').textContent = descricao;
        }

        // Event listeners
        if (corInput) {
            corInput.addEventListener('input', atualizarCorPreview);
            atualizarCorPreview();
        }

        if (valorMensalInput) {
            valorMensalInput.addEventListener('input', atualizarCalculos);
        }
        
        if (valorAnualInput) {
            valorAnualInput.addEventListener('input', atualizarCalculos);
        }
        
        if (duracaoInput) {
            duracaoInput.addEventListener('input', atualizarCalculos);
        }
        
        // Inicializar cálculos
        atualizarCalculos();

        if (nomeInput) {
            nomeInput.addEventListener('input', atualizarPreview);
        }
        
        if (descricaoInput) {
            descricaoInput.addEventListener('input', atualizarPreview);
        }

        // Atualizar preview inicial
        atualizarPreview();

        // Validação do formulário
        const form = document.getElementById('tipoForm');
        form.addEventListener('submit', function(e) {
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }
            form.classList.add('was-validated');
        });

        // Os campos de valor já têm type="number" e step="0.01" definidos no formulário Django
    });

    function confirmarExclusao() {
        new bootstrap.Modal(document.getElementById('modalExclusao')).show();
    }
</script>
{% endblock %}